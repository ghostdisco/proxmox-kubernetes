<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.103.1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://www.khanhph.com/install-proxmox-kubernetes/"><link rel=canonical href=https://www.khanhph.com/install-proxmox-kubernetes/><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT crossorigin=anonymous><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><link rel="shortcut icon" sizes=16x16 href=/images/favicon-16x16.png><link rel="shortcut icon" sizes=32x32 href=/images/favicon-32x32.png><link rel="shortcut icon" sizes=192x192 href=/images/android-chrome-192x192.png><link rel="shortcut icon" sizes=512x512 href=/images/android-chrome-512x512.png><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=alternate type=application/atom+xml href=https://www.khanhph.com/index.xml title="The Non-Stop Journey"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.khanhph.com\/"},"articleSection":"kubernetes","name":"Creating a Kubernetes cluster on Proxmox VE with Terraform \u0026 Kubespray","headline":"Creating a Kubernetes cluster on Proxmox VE with Terraform \u0026 Kubespray","description":"I\u0027ll show you how to create your own home-lab Kubernetes cluster on Proxmox using Terraform and Kubespray.","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2022","datePublished":"2022-12-30 05:21:00 \u002b0700 \u002b0700","dateModified":"2022-12-30 05:21:00 \u002b0700 \u002b0700","url":"https:\/\/www.khanhph.com\/install-proxmox-kubernetes\/","keywords":["kubernetes","proxmox","kubespray","terraform","homelab"]}</script><title>Creating a Kubernetes cluster on Proxmox VE with Terraform & Kubespray</title><meta property="og:title" content="Creating a Kubernetes cluster on Proxmox VE with Terraform & Kubespray"><meta property="og:type" content="article"><meta property="og:description" content="I'll show you how to create your own home-lab Kubernetes cluster on Proxmox using Terraform and Kubespray."><meta name=description content="I'll show you how to create your own home-lab Kubernetes cluster on Proxmox using Terraform and Kubespray."><meta name=twitter:title content="Creating a Kubernetes cluster on Proxmox VE with Terraform & Kubespray"><meta name=twitter:image content="https://www.khanhph.com/install-proxmox-kubernetes/images/onur-binay-Sa-0GdWMRRQ-unsplash.jpg"><meta property="og:image" content="https://www.khanhph.com/install-proxmox-kubernetes/images/onur-binay-Sa-0GdWMRRQ-unsplash.jpg"><meta name=twitter:creator content="@nonstopjourney_"><meta property="og:locale" content="en-us"><style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 1em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}img[src*='#center']{display:block;margin:auto}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><style>*,*::before,*::after{box-sizing:border-box}html{background-color:#fbfbfb;color:#303030;font-size:1rem}@media screen and (min-width:800px){html{font-size:1.125rem}}body{line-height:1.6;padding:0 20px}html,body{margin:0}p,figure,pre,blockquote{margin:0 0 1rem}hr{display:block;width:100%;height:0;margin:2rem 0;border:0;border-top:1px solid #686868}figure .representation{display:block;margin:0 0 .5rem}figcaption{padding:0 .5rem .5rem;font-size:.8125rem;text-align:right}figcaption .original::before{content:" ";display:block}img{max-width:100%}blockquote{padding:1rem;border-left:5px solid #e5e5e5;color:#686868;font-style:italic}blockquote p{margin:0}blockquote cite{display:block;margin:1rem 0 0;font-size:.875rem;text-align:right}ol,ul{margin:0 0 1rem 1.25rem;padding:0;list-style-position:outside}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}li{margin:0}li:not(last-of-type){margin-bottom:.4rem}abbr{border-bottom:1px dashed;text-decoration:none;cursor:help}kbd,code,pre{font-family:'"source code pro"',monospace}pre{max-width:100%}kbd,code{margin:0;padding:.125rem .25rem 0;background-color:#e5e5e5}.highlight code{padding:0}article,section{display:block;margin-bottom:1rem}h2,h3,h4,h5,h6{margin:0 0 .5rem;font-weight:700;line-height:1.6}h1{font-size:2.25rem;line-height:1.6}h2{font-size:1.875rem}h3{font-size:1.5rem}h4{font-size:1.25rem}h5{font-size:1rem}h6{font-size:.75rem}.container{width:100%;max-width:38rem;margin:0 auto;padding:.5rem}@media screen and (min-width:800px){.container{padding:1rem 0}}.site-header,.site-nav{margin-bottom:2rem}.site-header h1,.site-nav h1{margin-bottom:.5rem}.site-nav a::before{content:"\2190";margin-right:.25rem}.site-footer{margin:10px 0 0;font-size:.8125rem}.site-version{padding:20px 0}.site-footer [itemprop=sameAs]+[itemprop=sameAs]{margin-left:.4rem}@media screen and (min-width:800px){.site-footer{margin-bottom:.5rem}}.posts ol{margin-left:0;list-style:none}.posts li{margin-bottom:.8rem}.posts section{margin-bottom:4rem}@media screen and (min-width:800px){.posts li{display:flex;flex-direction:row}}.posts time{display:block}@media screen and (min-width:800px){.posts time{flex:0 0 5rem}}.posts time+a{margin-left:1rem}@media screen and (min-width:800px){.posts time+a{margin-left:2rem}}.post .post-header{margin-bottom:2rem}.post .post-date{display:block;margin:0 0 1rem;text-align:left;font-weight:400;font-style:normal}.hljs{font-size:.875rem}.chart-wrapper{display:flex;justify-content:center}.highlight code{font-size:.9em}img[src$="#center"]{display:block;margin:0 auto}.support{border:4px solid #f47edd;border-radius:10px;padding:1.6em;text-align:center}.support p{margin-bottom:1em}.support button{cursor:pointer;background:#f47edd;border:1px solid #f47edd;border-radius:4px;color:#fff;font-family:arvo,serif;font-size:1em;text-transform:uppercase;padding:.3em .6em}.header-title a{border-bottom:none}.header-line{padding-bottom:12px}.markdown-body code{margin:0;padding:.125rem .25rem 0;background-color:#e5e5e5;font-size:100%;color:#000}.post-title{font-size:2.25rem}table{margin-bottom:1rem}table.has-image{font-size:.8125rem;margin-bottom:1.5rem;margin-left:auto;margin-right:auto}table.has-image img{margin:0 auto}.highlight span{color:#fff}.nav-link{color:#000}.date-container{text-align:justify}.date-container::after{content:"";display:inline-block;width:100%}.published-date,.modified-date{display:inline-block}.post-tags{display:inline-block;background-color:#e2e8f0;padding:5px 10px;margin-right:8px;font-size:14px;font-weight:700;text-decoration:none;transition:background-color .3s ease;border:none;border-radius:2px}.post-tags:hover{background-color:#fff}.post-tags a:hover{text-decoration:none}#toc{padding:2em;margin:20px 0;background-color:#f5f5f5;border-radius:2%}#toc a{text-decoration:none!important}</style><style>.header-title,.header-subtitle{display:none}</style><style>html,body,.header-title{font-family:arvo,serif}</style><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css?family=Arvo" rel=stylesheet><link href=/index.xml rel=alternate type=application/rss+xml title="The Non-Stop Journey"></head><body><article class=post id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>The Non-Stop Journey</a></div><div class=header-subtitle>A deep dive into the world of DevOps and Programming</div></header><ul class="nav justify-content-end"><li class=nav-item><a class=nav-link href=/>Home</a></li></ul><div class="row end-xs"></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Creating a Kubernetes cluster on Proxmox VE with Terraform & Kubespray</h1><div class=date-container><span class=published-date datetime="29 Dec 2022">29 Dec 2022</span>
<span class=modified-date datetime="28 Sep 2023">Last updated on 28 Sep 2023</span></div></header><div class="post-content markdown-body"><h2 id=introduction>Introduction</h2><p>As a DevOps engineer, I was tasked with taking more deep dive into how I can take the benefit of Kubernetes in managing containers. I wanted to have a production-like Kubernetes cluster for learning and testing purposes but found the cost of a managed cluster on the cloud to be prohibitively high. The credits of my trial account went away just after a few days of playing around with Kubernetes on the cloud. I started to look for alternative solutions, and my search led me to Proxmox, Terraform, and Kubespray.</p><table><thead><tr><th style=text-align:center><div class=img-container><img style=max-width:100%;width:auto;height:auto src=/install-proxmox-kubernetes/images/onur-binay-Sa-0GdWMRRQ-unsplash_hu92feede356c6ae61c4689d41adfb0b0c_2239894_1200x0_resize_q75_h2_box.webp width=1200 height=600 alt="Home lab"></div></th></tr></thead><tbody><tr><td style=text-align:center>Photo by <a href=https://unsplash.com/@onurbinay rel=nofollow target=_blank>Onur Binay</a> on <a href=https://unsplash.com/ rel=nofollow target=_blank>Unplash</a></td></tr></tbody></table><p>In this blog, I will share my journey and experiences, hoping to inspire you to create your own home lab Kubernetes cluster on Proxmox VE using Terraform and Kubespray.</p><div id=toc><h3 class=toc-title>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#installing-required-components>Installing required components</a></li><li><a href=#creating-the-kubernetes-cluster>Creating the Kubernetes cluster</a></li><li><a href=#setting-up-ssh-configuration>Setting up SSH configuration</a></li><li><a href=#verifying-the-kubernetes-cluster>Verifying the Kubernetes cluster</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li></ul></nav></div><h2 id=prerequisites>Prerequisites</h2><h3 id=software-requirements>Software requirements</h3><ul><li><p><strong>Proxmox Virtual Environment >= 7.3.3</strong>:</p><p>Proxmox VE is an open-source server virtualization management solution for creating and managing VMs, containers and HA clusters, etc. To proceed with the installation, you need to have Proxmox VE installed on either a dedicated server or a VM with virtualization enabled.</p><p>If you haven&rsquo;t installed Proxmox VE yet, you can follow the instruction from the official Proxmox website: <a href=https://www.proxmox.com/en/proxmox-ve/get-started/ rel=nofollow target=_blank>Download and install Proxmox VE</a>.</p></li><li><p><strong>Terraform >= 1.3.3</strong></p><p>Terraform is an Infrastructure as Code (IaC) tool that enables efficient building, changing and versioning of cloud and on-prem resources. It plays a crucial role in provisioning and setting up VMs on Proxmox VE declaratively.</p><p>If you haven&rsquo;t installed Terraform CLI yet, you can find the installation instruction from the official Hashicorp website: <a href=https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli/ rel=nofollow target=_blank>Install Terraform CLI</a>.</p></li><li><p><strong>Kubespray >= 2.20</strong></p><p>Kubespray is a tool shipped with Python, Ansible and a collection of playbooks necessary for making up a production-ready Kubernetes cluster. The good news is that you don&rsquo;t need to worry about manually installing Kubespray. The installation of Kubespray will be seamlessly handled by Terraform, which we will discuss later.</p><p>Anyway, if you are interested in exploring more about this cool stuff, you can check out the official repository: <a href=https://github.com/kubernetes-sigs/kubespray rel=nofollow target=_blank>kubernetes-sigs/kubespray</a>.</p></li></ul><table><thead><tr><th style=text-align:center><div class=img-container><img style=max-width:100%;width:auto;height:auto src=/install-proxmox-kubernetes/images/proxmox-kubernetes-softwares_hu4bd745a215dbfb01b83e035a024b8eee_224375_1200x0_resize_q75_h2_box_3.webp width=1200 height=475 alt="Terraform acts as a client, utilizing Proxmox VE API to request VM provisiong, and it also triggers Kubespray to install essential services to enable Kubernetes funtionality on the VMs."></div></th></tr></thead><tbody><tr><td style=text-align:center>How Proxmox VE, Terraform and Kubespray play a role in creating a k8s cluster</td></tr></tbody></table><h3 id=system-requirements>System requirements</h3><p>Before we start the deployment in Proxmox VE, let&rsquo;s ensure we have the following components in place:</p><ul><li><strong>Internal network</strong></li><li><strong>VM template</strong></li><li><strong>SSH key pair</strong></li><li><strong>Bastion host</strong></li></ul><p>In the next section, I will provide a step-by-step procedure on how to configure each of the required components.</p><h2 id=installing-required-components>Installing required components</h2><p>If you have already set up these things in Proxmox VE, feel free to skip this section and jump into the next part.</p><h3 id=configuring-an-internal-network>Configuring an internal network</h3><p>We need to have an internal network set up beforehand. Instead of plugging Kubernetes nodes into the default Proxmox VE bridge <code>vmbr0</code>, I would recommend you to put all of them into a dedicated internal network. This approach offers several benefits, including improved security by isolating the cluster from the LAN network and allowing more granular control over network configurations.</p><table><thead><tr><th style=text-align:center><div class=img-container><img style=max-width:100%;width:auto;height:auto src=/install-proxmox-kubernetes/images/rudimentary-home-lab-networking-setup_hu7e24e80ab4c40ac9e312f433f8ff016e_307896_1200x0_resize_q75_h2_box_3.webp width=1200 height=691 alt="Putting Kubernetes VM into a dedicated internal network."></div></th></tr></thead><tbody><tr><td style=text-align:center>Rudimentary home lab networking setup</td></tr></tbody></table><p>To configure an internal network in Proxmox VE, follow these instructions:</p><ol><li><p>Start a new shell session on your Proxmox VE server and switch to the Root shell if you haven&rsquo;t already.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -i
</span></span></code></pre></div></li><li><p>Take a backup of the network configuration file <code>/etc/network/interfaces</code>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp /etc/network/interfaces /etc/network/interfaces.original
</span></span></code></pre></div></li><li><p>Open the <code>/etc/network/interfaces</code> file in a text editor and append the below configuration for the new network <code>vmbr1</code>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># /etc/network/interfaces
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span># Dedicated internal network for Kubernetes cluster
</span></span><span style=display:flex><span>auto vmbr1
</span></span><span style=display:flex><span>iface vmbr1 inet static
</span></span><span style=display:flex><span>    address  10.0.1.1/24
</span></span><span style=display:flex><span>    bridge-ports none
</span></span><span style=display:flex><span>    bridge-stp off
</span></span><span style=display:flex><span>    bridge-fd 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    post-up   echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span style=display:flex><span>    post-up   iptables -t nat -A POSTROUTING -s &#39;10.0.1.0/24&#39; -o vmbr0 -j MASQUERADE
</span></span><span style=display:flex><span>    post-down iptables -t nat -D POSTROUTING -s &#39;10.0.1.0/24&#39; -o vmbr0 -j MASQUERADE
</span></span></code></pre></div><p>The above configuration does the following:</p><ul><li>Define the new network bridge <code>vmbr1</code> that should be brought up during system boot.</li><li>Assign it a fixed IP address <code>10.0.1.1</code> with a subnet mask of <code>/24</code>. This presents a network range from <code>10.0.1.0</code> to <code>10.0.1.255</code>.</li><li>Configure Masquerading (NAT) with <code>iptables</code> that allows any outgoing traffic (internet access) from the Kubernetes VMs can happen through <code>vmbr0</code>.</li></ul></li></ol><ul><li><p>Execute <code>ifreload</code> command to apply the changes.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ifreload -a
</span></span></code></pre></div><p>If for any reason <code>ifreload</code> does not bring up the network, it&rsquo;s worth considering a server reboot.</p></li></ul><p>Please note that the given configuration is a rudimentary example. You may need to customize it further to suit your specific needs. For more information, refer to this wiki: <a href=https://pve.proxmox.com/wiki/Network_Configuration rel=nofollow target=_blank>Proxmox network configuration</a>.</p><h3 id=preparing-a-vm-template>Preparing a VM template</h3><p>To streamline the VM creation process, it&rsquo;s vital to prepare an Ubuntu image with some desired configurations and make it a Proxmox VE template. Terraform will create the Kubespray VM and Kubernetes nodes by cloning this template.</p><p>The steps to create your own VM template are following:</p><ol><li><p>Start a new shell session on your Proxmox VE server and switch to the Root shell if you haven&rsquo;t already.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -i
</span></span></code></pre></div></li><li><p>Run the following command to create the VM template:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s https://raw.githubusercontent.com/khanh-ph/proxmox-scripts/master/create-vm-template/script.sh | bash
</span></span></code></pre></div><p>Upon completion of the script, you will have a VM template created with the below specification:</p><ul><li>Template VM ID: <code>9000</code></li><li>OS: <code>Ubuntu 22.04</code></li><li>Capabilities/options enabled: <code>QEMU Guest Agent</code>, <code>Cloud-init</code>, <code>CPU and Memory hotplug</code>.</li></ul></li></ol><p>In case you want to custom the VM template on your own, you can refer to this blog post: <a href=https://austinsnerdythings.com/2021/08/30/how-to-create-a-proxmox-ubuntu-cloud-init-image/ rel=nofollow target=_blank>How to create a Proxmox Ubuntu cloud-init image</a>.</p><h3 id=generating-an-ssh-key-pair>Generating an SSH key pair</h3><p>User authentication is a crucial part that we need to handle. Rather than using a password to log in to the VM, we will configure SSH-based authentication to enhance network security and eliminate the need to remember another password in life.</p><p>In this sub-section, I will walk you through the steps of creating a dedicated key pair for the Kubernetes admin user.</p><ol><li><p>Open a terminal on your local workstation.</p></li><li><p>Create a directory to store the key pair.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/proxmox-kubernetes/ssh-keys
</span></span></code></pre></div></li><li><p>Generate an SSH key pair and save it to the specified directory.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-keygen -t rsa -b <span style=color:#3677a9>4096</span> -f ~/proxmox-kubernetes/ssh-keys/id_rsa -C <span style=color:#ed9d13>&#34;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3a510249175b5e5753547a59564f494e5f48145655595b56">[email&#160;protected]</a>&#34;</span>
</span></span></code></pre></div></li></ol><p>Now, you&rsquo;ve successfully created the key pair for k8s admin. Let&rsquo;s take note of the file locations.</p><ul><li>Private key: <code>~/proxmox-kubernetes/ssh-keys/id_rsa</code></li><li>Public key: <code>~/proxmox-kubernetes/ssh-keys/id_rsa.pub</code></li></ul><h3 id=setting-up-a-bastion-host>Setting up a bastion host</h3><p>Being placed within an internal network, all the VMs are not directly reachable. To enable administrative access to the cluster as well as facilitate remote execution of the scripts on Kubespray VM, we need a <a href=https://en.wikipedia.org/wiki/Bastion_host rel=nofollow target=_blank>bastion host</a> to serve as an SSH proxy.</p><p>From an infrastructure perspective, the bastion host is a regular VM that is attached to both your LAN network and your internal networks. Below is a step-by-step procedure to provision it:</p><ol><li><p>Start a new shell session on your Proxmox VE server and switch to the Root shell if you haven&rsquo;t already.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -i
</span></span></code></pre></div></li><li><p>Create a new VM by cloning the VM template we&rsquo;ve just created.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qm clone <span style=color:#3677a9>9000</span> <span style=color:#3677a9>9001</span> --name bastion --full <span style=color:#24909d>true</span>
</span></span></code></pre></div><p>In the above command, <code>9000</code> is the ID of the template and <code>9001</code> is the ID of our bastion VM.</p></li><li><p>Configure SSH keys for bastion user authentication.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qm <span style=color:#24909d>set</span> <span style=color:#3677a9>9001</span> --sshkey ~/proxmox-kubernetes/ssh-keys/id_rsa.pub
</span></span></code></pre></div><p>In this command, I specified the location of the public key we&rsquo;ve generated for the k8s admin user.</p></li><li><p>Plug the bastion VM into the LAN network by setting the appropriate IP and gateway configuration. Replace <code>192.168.1.131</code> with your desired IP.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qm <span style=color:#24909d>set</span> <span style=color:#3677a9>9001</span> --net0 virtio,bridge=vmbr0 --ipconfig0 <span style=color:#40ffff>ip</span>=192.168.1.131/24,gw=192.169.1.1
</span></span></code></pre></div></li><li><p>Connect the bastion VM to the Kubernetes internal network bridge <code>vmbr1</code>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qm <span style=color:#24909d>set</span> <span style=color:#3677a9>9001</span> --net1 virtio,bridge=vmbr1 --ipconfig1 <span style=color:#40ffff>ip</span>=10.0.1.2/24,gw=10.0.1.1
</span></span></code></pre></div></li><li><p>Start the bastion VM.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qm start <span style=color:#3677a9>9001</span>
</span></span></code></pre></div></li><li><p>Verify if you are able to SSH to the bastion VM from within the local network. Replace <code>ubuntu</code> with your desired username if you&rsquo;ve customized it.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="106572657e6465502129223e2126283e213e212321">[email&#160;protected]</a> -i ~/proxmox-kubernetes/ssh-keys/id_rsa
</span></span></code></pre></div></li></ol><p>In the real-world scenario, it&rsquo;s of paramount importance to harden the bastion host, and also make it accessible outside of your local network. However, within the context of this blog, they are more of &ldquo;extra credit&rdquo; options. You can explore <a href=https://goteleport.com/blog/ssh-jump-server/ rel=nofollow target=_blank>security practice</a> for guidance on hardening the bastion host. To make the bastion publicly accessible, consult with your ISP for assistance in configuring NAT on your specific router model.</p><h2 id=creating-the-kubernetes-cluster>Creating the Kubernetes cluster</h2><p>Now comes the most exciting part. Let&rsquo;s make your very own Kubernetes cluster.</p><h3 id=overview-of-the-plan>Overview of the plan</h3><p>Before we start, let&rsquo;s go over the plan with Terraform and Kubespray:</p><ul><li>First, we&rsquo;ll create at least 3 regular VMs on Proxmox VE, which will act as the backbone of the Kubernetes cluster.</li><li>Next, we&rsquo;ll create an additional VM and install Kubespray on it.</li><li>To personalize the cluster, we&rsquo;ll customize the Kubespray configuration files:<ul><li><code>inventory.ini</code></li><li><code>addons.yaml</code></li><li><code>k8s-cluster.yaml</code></li></ul></li><li>Finally, we&rsquo;ll transform the regular VMs from the first step into Kubernetes nodes by instructing Kubespray to work its magic.</li></ul><p>It might seem a lot but don&rsquo;t worry, I have made a repository <a href=https://github.com/khanh-ph/proxmox-kubernetes rel=nofollow target=_blank>proxmox-kubernetes</a> that simplifies the process with pre-built Terraform stuff.</p><p>So, here is the revised plan:</p><ul><li>Clone the repository.</li><li>Configure the necessary Terraform variables to make it your own.</li><li>Run a few Terraform commands.</li><li>Enjoy a cup of coffee while the magic happens.</li></ul><p>Sounds much better, right? Let&rsquo;s get started.</p><h3 id=initiating-the-deployment>Initiating the deployment</h3><ol><li><p>Start by cloning the <code>proxmox-kubernetes</code> repository.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/khanh-ph/proxmox-kubernetes.git
</span></span></code></pre></div></li><li><p>Change your working directory to <code>proxmox-kubernetes</code>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#24909d>cd</span> proxmox-kubernetes
</span></span></code></pre></div></li><li><p>Checkout the version <code>4.1.0</code>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git checkout 4.1.0
</span></span></code></pre></div><blockquote><p>Note: This version has been tested and verified as part of the steps outlined in this blog post.</p></blockquote></li><li><p>Open the <code>example.tfvars</code> file in a text editor and update all the mandatory variables with your own values.</p><blockquote><p>Note: There are optional variables available that allow you to customize your Kubespray configuration to meet your requirements. For more details, refer to the <code>README.md</code> file in the repository <a href=https://github.com/khanh-ph/proxmox-kubernetes rel=nofollow target=_blank>proxmox-kubernetes</a>.</p></blockquote></li><li><p>Initialize the Terraform working directory.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform init
</span></span></code></pre></div></li><li><p>Generate an execution plan and review the output to ensure the planned changes align with your expectations.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform plan -var-file=<span style=color:#ed9d13>&#34;example.tfvars&#34;</span>
</span></span></code></pre></div></li><li><p>If you&rsquo;re satisfied with the plan and ready to apply the changes, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform apply -var-file=<span style=color:#ed9d13>&#34;example.tfvars&#34;</span>
</span></span></code></pre></div><p>Terraform will prompt for confirmation before applying the changes. Type yes and press Enter to proceed.</p></li><li><p>Take a breather and enjoy a cup of coffee while waiting for the deployment to finish.</p></li></ol><h2 id=setting-up-ssh-configuration>Setting up SSH configuration</h2><p>After the cluster provisioning is done, you might want to access the cluster VMs for futher setup and management. Since all the Kubernetes nodes are placed on an internal network, it&rsquo;s vital to set up the SSH configuration for the Bastion host beforehand. Once configured, we can use the Bastion as a proxy for SSH connections from your local workstation to those internal machines.</p><p>Here are the instructions:</p><ol><li><p>On your local workstation, open the <code>~/.ssh/config</code> file with your favorite text editor.</p></li><li><p>Define the SSH profile for your Bastion host by appending the following text block to that file:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#999;font-style:italic># ~/.ssh/config</span>
</span></span><span style=display:flex><span>Host k8s-bastion
</span></span><span style=display:flex><span>    HostName 192.168.1.131
</span></span><span style=display:flex><span>    User ubuntu
</span></span><span style=display:flex><span>    Port <span style=color:#3677a9>22</span>
</span></span><span style=display:flex><span>    IdentityFile ~/proxmox-kubernetes/ssh-keys/id_rsa
</span></span></code></pre></div><p>Ensure you replace <code>192.168.1.131</code> with the public-facing IP of your Bastion host.</p></li><li><p>Next, add another block that informs your SSH client how to access the Kubernetes VMs.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#999;font-style:italic># ~/.ssh/config</span>
</span></span><span style=display:flex><span>Host 10.0.1.*
</span></span><span style=display:flex><span>    User ubuntu
</span></span><span style=display:flex><span>    Port <span style=color:#3677a9>22</span>
</span></span><span style=display:flex><span>    IdentityFile ~/proxmox-kubernetes/ssh-keys/id_rsa
</span></span><span style=display:flex><span>    ProxyJump k8s-bastion 
</span></span></code></pre></div><p>In this example, I&rsquo;ve used the pattern <code>10.0.1.*</code> to match all the hosts in my Kubernetes dedicated network <code>10.0.1.0/24</code>. Please adjust the pattern if your network has a different CIDR. The last line is to utilize the Bastion host for stdio forwarding from your SSH client to the SSH server on the target VMs.</p></li></ol><h2 id=verifying-the-kubernetes-cluster>Verifying the Kubernetes cluster</h2><p>Once the deployment is complete, it&rsquo;s essential to verify the status of all the system pods running on the Kubernetes cluster.</p><p>Follow these steps:</p><ol><li><p>Open a new terminal on your local workstation.</p></li><li><p>Determine the IP of a Kubernetes cluster&rsquo;s control plane. You can obtain this information from the output of the <code>terraform apply</code> command that we executed in the previous section.</p></li><li><p>SSH into the Kubernetes control plane node.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh 10.0.1.10
</span></span></code></pre></div></li><li><p>When you are on the Kubernetes node, use <code>kubectl</code> to list all the pods.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubectl get pods -n kube-system
</span></span></code></pre></div><p>A cluster is considered to be successfully provisioned when all the system pods are up and running. See the below for an example output:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ubuntu@dev-k8s-cplane-00:~$ sudo kubectl get pods -n kube-system
</span></span><span style=display:flex><span>NAME                                                      READY   STATUS    RESTARTS        AGE
</span></span><span style=display:flex><span>calico-kube-controllers-6dd854d97b-j8jfk                  1/1     Running   <span style=color:#3677a9>1</span> (4d16h ago)   6d16h
</span></span><span style=display:flex><span>calico-node-4b99w                                         1/1     Running   <span style=color:#3677a9>1</span> (4d16h ago)   6d16h
</span></span><span style=display:flex><span>calico-node-l4kfs                                         1/1     Running   <span style=color:#3677a9>0</span>               6d16h
</span></span><span style=display:flex><span>calico-node-rt5nw                                         1/1     Running   <span style=color:#3677a9>0</span>               5d16h
</span></span><span style=display:flex><span>calico-node-t5ms9                                         1/1     Running   <span style=color:#3677a9>0</span>               6d16h
</span></span><span style=display:flex><span>coredns-79d86db9f9-crbf4                                  1/1     Running   <span style=color:#3677a9>0</span>               6d16h
</span></span><span style=display:flex><span>coredns-79d86db9f9-cvvdl                                  1/1     Running   <span style=color:#3677a9>0</span>               6d16h
</span></span><span style=display:flex><span>dns-autoscaler-7c59b6c489-dq9z9                           1/1     Running   <span style=color:#3677a9>0</span>               6d16h
</span></span><span style=display:flex><span>kube-apiserver-dev-k8s-cplane-00                          1/1     Running   <span style=color:#3677a9>1</span>               6d16h
</span></span><span style=display:flex><span>kube-controller-manager-dev-k8s-cplane-00                 1/1     Running   <span style=color:#3677a9>3</span>               6d16h
</span></span><span style=display:flex><span>kube-proxy-g44dg                                          1/1     Running   <span style=color:#3677a9>1</span> (4d16h ago)   5d16h
</span></span><span style=display:flex><span>kube-proxy-t5h4b                                          1/1     Running   <span style=color:#3677a9>0</span>               5d16h
</span></span><span style=display:flex><span>kube-proxy-x5dkz                                          1/1     Running   <span style=color:#3677a9>0</span>               5d16h
</span></span><span style=display:flex><span>kube-proxy-xlc9p                                          1/1     Running   <span style=color:#3677a9>0</span>               5d16h
</span></span><span style=display:flex><span>kube-scheduler-dev-k8s-cplane-00                          1/1     Running   <span style=color:#3677a9>1</span>               6d16h
</span></span><span style=display:flex><span>nginx-proxy-dev-k8s-worker-00                             1/1     Running   <span style=color:#3677a9>1</span> (4d16h ago)   6d16h
</span></span><span style=display:flex><span>nginx-proxy-dev-k8s-worker-01                             1/1     Running   <span style=color:#3677a9>0</span>               6d16h
</span></span><span style=display:flex><span>nginx-proxy-dev-k8s-worker-02                             1/1     Running   <span style=color:#3677a9>0</span>               5d16h
</span></span></code></pre></div></li></ol><h2 id=conclusion>Conclusion</h2><p>In summary, we&rsquo;ve successfully provisioned a simple home lab Kubernetes cluster on Proxmox VE with Terraform & Kubespray. This approach allows us to manage the infrastructure in a declarative manner and effortlessly scale up and out nodes within the cluster. While it serves as a solid starting point, there is much more to be done to elevate the cluster to a production-ready environment. Future steps involve enhancing the cluster with features like security, high availability, observability and performance optimization.</p><p>Happy Kubernetes-ing!</p><h2 id=references>References</h2><ul><li><a href=https://austinsnerdythings.com/2021/09/23/deploying-kubernetes-vms-in-proxmox-with-terraform rel=nofollow target=_blank>Deploying Kubernetes VMs in Proxmox with Terraform</a></li><li><a href=https://medium.com/@ssnetanel/build-a-kubernetes-cluster-using-k3s-on-proxmox-via-ansible-and-terraform-c97c7974d4a5/ rel=nofollow target=_blank>Build a Kubernetes cluster using K3S on Proxmox via Ansible and Terraform</a></li></ul></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/kubernetes/>kubernetes</a></div><div class=post-tags><a href=/tags/proxmox/>proxmox</a></div><div class=post-tags><a href=/tags/kubespray/>kubespray</a></div><div class=post-tags><a href=/tags/terraform/>terraform</a></div><div class=post-tags><a href=/tags/homelab/>homelab</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=post-comments><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src=https://utteranc.es/client.js repo=khanh-ph/khanhph-utterances issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div class=header-line></div><div class=site-footer><div class=site-footer-item><span>Author: </span>Khanh Pham</div><div class=site-footer-item><span>Contact me:</span>
<a href="/cdn-cgi/l/email-protection#eb80838a85839b838a86dadbd2daab8c868a8287c5888486" target=_blank>Email</a>
<a href=https://github.com/khanh-ph target=_blank>Github</a>
<a href=https://twitter.com/nonstopjourney_ target=_blank>Twitter</a></div></div><div class=site-version style=font-size:.6em;text-align:right><span>The Non-Stop Journey v0.12.1</span></div></div></div></div></article><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>var tables=document.querySelectorAll("table");tables.forEach(function(e){if(e.rows[0].cells[0].innerHTML.indexOf("<img")<0)e.className="table table-bordered table-striped";else{e.className="has-image";let t=e.getElementsByTagName("img");for(let e=0;e<t.length;e++){let n=t[e],s=n.getAttribute("width"),o=s*.7;n.style.width=o+"px"}}})</script></body></html>